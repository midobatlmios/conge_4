import{r as l,j as e,a as M,S as re}from"./app-Ce2YBpep.js";import{g as K,h as Q,i as Z,j as ee,l as te,k as ae}from"./app-layout-Df8PrIGE.js";import{a as de,B as z}from"./createLucideIcon-n0k5XbGK.js";import{I as T}from"./input-CLdAzZZD.js";import{S as R,f as U,g as $,h as X,i as g}from"./select-WDzcoPeP.js";const H=l.forwardRef(({className:I,...y},m)=>e.jsx("textarea",{className:de("flex min-h-[80px] w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50",I),ref:m,...y}));H.displayName="Textarea";const xe=({isOpen:I,onClose:y,isAdmin:m=!1,users:V=[]})=>{var J;const s=new Date().toISOString().split("T")[0],D=(J=document.querySelector('meta[name="user-id"]'))==null?void 0:J.getAttribute("content"),[S,N]=l.useState(""),[k,F]=l.useState(s),[r,h]=l.useState(""),[j,f]=l.useState(""),[_,q]=l.useState(0),[u,o]=l.useState(""),[t,c]=l.useState("mariage"),[b,x]=l.useState("en attente"),[v,E]=l.useState(""),[p,B]=l.useState({}),[A,C]=l.useState(null),[L,W]=l.useState(!1);l.useEffect(()=>{if(r&&j){const a=new Date(r),i=new Date(j);if(!isNaN(a.getTime())&&!isNaN(i.getTime())){const d=Math.abs(i.getTime()-a.getTime()),n=Math.ceil(d/(1e3*60*60*24))+1;q(n),o(a.getFullYear().toString())}}},[r,j]),l.useEffect(()=>{h(""),f(""),q(0),o(""),E("");const i=new Date().toISOString().split("T")[0];F(i);let d,n;switch(t){case"mariage":d=new Date,d.setDate(d.getDate()+1),n=new Date(d),n.setDate(n.getDate()+3),h(d.toISOString().split("T")[0]),f(n.toISOString().split("T")[0]);break;case"naissance":d=new Date,d.setDate(d.getDate()+1),n=new Date(d),n.setDate(n.getDate()+2),h(d.toISOString().split("T")[0]),f(n.toISOString().split("T")[0]);break;case"deces":d=new Date,d.setDate(d.getDate()+1),n=new Date(d),n.setDate(n.getDate()+2),h(d.toISOString().split("T")[0]),f(n.toISOString().split("T")[0]);break;case"recuperation":E("Veuillez préciser les dates à récupérer");break}},[t]),l.useEffect(()=>{if(r){const a=new Date(r),i=new Date(a);switch(t){case"mariage":i.setDate(i.getDate()+2);break;case"naissance":i.setDate(i.getDate()+1);break;case"deces":i.setDate(i.getDate()+1);break;default:return}f(i.toISOString().split("T")[0])}},[r,t]);const se=a=>{const i=a.target.value;if(h(i),i){const d=new Date(i),n=new Date(d);switch(t){case"mariage":n.setDate(n.getDate()+2);break;case"naissance":n.setDate(n.getDate()+1);break;case"deces":n.setDate(n.getDate()+1);break;default:return}f(n.toISOString().split("T")[0])}},ne=()=>{const a={};if(m&&!S&&(a.user_id="Veuillez sélectionner un employé"),k||(a.date_demande="Date de demande is required"),r||(a.date_debut="Date de début is required"),j||(a.date_fin="Date de fin is required"),r&&j){const i=new Date(r),d=new Date(j);switch(d<i&&(a.date_fin="Date de fin must be after Date de début"),t){case"mariage":_>4&&(a.nbr_jours="Vous ne pouvez pas renseigner plus de 4 jours pour ce type de congé");break;case"naissance":{const n=new Date(r),O=new Date(n);O.setMonth(O.getMonth()+1),d>O&&(a.date_fin="Le congé de naissance doit être pris dans un délai d'un mois");break}case"deces":_>3&&(a.nbr_jours="Vous ne pouvez pas renseigner plus de 3 jours pour ce type de congé");break;case"recuperation":v||(a.comment="Veuillez renseigner les dates sujet de récupération");break}}return _<=0&&(a.nbr_jours="Nombre de jours must be greater than 0"),u||(a.annee="Année is required"),b||(a.etat="Etat is required"),B(a),Object.keys(a).length===0},Y=async a=>{var i,d,n,O,G;if(a.preventDefault(),C(null),!D){C({type:"error",text:"User ID not found. Please make sure you are logged in."});return}if(ne()){W(!0);try{const w={date_demande:k,date_debut:r,date_fin:j,nbr_jours:_,annee:u,type_conge:t,etat:b,comment:v,user_id:m?S:D};(await M.post("/demandes",w,{headers:{"X-Requested-With":"XMLHttpRequest",Accept:"application/json"},withCredentials:!0})).data&&(C({type:"success",text:"Demande ajoutée avec succès"}),F(s),h(""),f(""),q(0),o(""),c("mariage"),x("en attente"),E(""),setTimeout(()=>{y(),re.reload()},1500))}catch(w){console.error("Error adding demande:",w),M.isAxiosError(w)?((i=w.response)==null?void 0:i.status)===419?C({type:"error",text:"Session expirée. Veuillez rafraîchir la page et réessayer."}):(n=(d=w.response)==null?void 0:d.data)!=null&&n.errors?(B(w.response.data.errors),C({type:"error",text:"Veuillez corriger les erreurs dans le formulaire"})):C({type:"error",text:((G=(O=w.response)==null?void 0:O.data)==null?void 0:G.message)||"Une erreur s'est produite lors de l'ajout de la demande"}):C({type:"error",text:"Une erreur inattendue s'est produite"})}finally{W(!1)}}};return e.jsx(K,{open:I,onOpenChange:y,children:e.jsxs(Q,{className:"max-h-[90vh] flex flex-col w-[95vw] sm:w-[85vw] md:w-[75vw] lg:w-[60vw] xl:w-[50vw]",children:[e.jsxs(Z,{children:[e.jsx(ee,{children:"Ajouter une demande de congé"}),e.jsx(te,{children:"Remplissez le formulaire ci-dessous pour soumettre une nouvelle demande de congé."})]}),e.jsx("div",{className:"flex-1 overflow-y-auto pr-4 -mr-4",children:e.jsxs("form",{onSubmit:Y,className:"space-y-4",children:[A&&e.jsx("div",{className:`p-2 rounded ${A.type==="success"?"bg-green-200 text-green-800":"bg-red-200 text-red-800"}`,children:A.text}),m&&e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{htmlFor:"user_id",className:"text-sm font-medium",children:"Employé"}),e.jsxs(R,{value:S,onValueChange:N,children:[e.jsx(U,{className:p.user_id?"border-red-500":"",children:e.jsx($,{placeholder:"Sélectionner un employé"})}),e.jsx(X,{children:V.map(a=>e.jsx(g,{value:a.id.toString(),children:a.name},a.id))})]}),p.user_id&&e.jsx("p",{className:"text-red-500 text-xs",children:p.user_id})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{htmlFor:"type_conge",className:"text-sm font-medium",children:"Type de congé"}),e.jsxs(R,{value:t,onValueChange:a=>{c(a)},children:[e.jsx(U,{children:e.jsx($,{placeholder:"Sélectionner un type de congé"})}),e.jsxs(X,{children:[e.jsx(g,{value:"mariage",children:"Congé de Mariage (4 jours max)"}),e.jsx(g,{value:"naissance",children:"Congé de Naissance (3 jours)"}),e.jsx(g,{value:"deces",children:"Congé de Décès (3 jours max)"}),e.jsx(g,{value:"sans_solde",children:"Congé sans solde"}),e.jsx(g,{value:"recuperation",children:"Récupération"})]})]}),t==="mariage"&&e.jsx("p",{className:"text-sm text-gray-500",children:"4 jours dont deux jours payés et deux jours déduits automatiquement du congé"}),t==="naissance"&&e.jsx("p",{className:"text-sm text-gray-500",children:"3 jours - à prendre dans un délai de un mois à compter de la date de la naissance"}),t==="deces"&&e.jsx("p",{className:"text-sm text-gray-500",children:"3 jours (décès conjoint, d'un enfant, d'un petit-enfant, d'un ascendant), dont un jour payé et deux jours déduits automatiquement du congé"}),t==="sans_solde"&&e.jsx("p",{className:"text-sm text-gray-500",children:"Ce congé sera déduit automatiquement de votre salaire"}),t==="recuperation"&&e.jsx("p",{className:"text-sm text-gray-500",children:"La journée à récupérer doit se faire dans un délai de 2 mois"})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{htmlFor:"nbr_jours",className:"text-sm font-medium",children:"Nombre de jours"}),e.jsx(T,{id:"nbr_jours",type:"number",name:"nbr_jours",value:_,className:"w-full",readOnly:!0}),e.jsx("p",{className:"text-gray-500 text-xs",children:"Calculé automatiquement à partir des dates"})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{htmlFor:"date_debut",className:"text-sm font-medium",children:"Date de début"}),e.jsx(T,{id:"date_debut",type:"date",name:"date_debut",value:r,onChange:se,className:p.date_debut?"border-red-500":"",required:!0}),p.date_debut&&e.jsx("p",{className:"text-red-500 text-xs",children:p.date_debut[0]})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{htmlFor:"date_fin",className:"text-sm font-medium",children:"Date de fin"}),e.jsx(T,{id:"date_fin",type:"date",name:"date_fin",value:j,onChange:a=>f(a.target.value),className:p.date_fin?"border-red-500":"",required:!0,readOnly:t==="mariage"||t==="naissance"||t==="deces"}),p.date_fin&&e.jsx("p",{className:"text-red-500 text-xs",children:p.date_fin[0]}),(t==="mariage"||t==="naissance"||t==="deces")&&e.jsx("p",{className:"text-sm text-gray-500",children:"La date de fin est automatiquement calculée en fonction de la date de début"})]})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{htmlFor:"comment",className:"text-sm font-medium",children:"Commentaire"}),e.jsx(H,{id:"comment",name:"comment",value:v||"",onChange:a=>E(a.target.value),placeholder:"Entrez la raison de votre demande...",className:`min-h-[100px] ${p.comment?"border-red-500":""}`}),p.comment&&e.jsx("p",{className:"text-red-500 text-xs",children:p.comment[0]})]})]})}),e.jsxs(ae,{className:"mt-4 flex-col sm:flex-row gap-2",children:[e.jsx(z,{variant:"outline",type:"button",onClick:y,disabled:L,className:"w-full sm:w-auto",children:"Annuler"}),e.jsx(z,{type:"submit",disabled:L,onClick:Y,className:"w-full sm:w-auto",children:L?"Envoi...":"Soumettre la demande"})]})]})})},pe=({isOpen:I,onClose:y,demande:m,onUpdate:V,isAdmin:P=!1})=>{const[s,D]=l.useState({id:0,user_id:0,date_demande:new Date().toISOString().split("T")[0],date_debut:"",date_fin:"",nbr_jours:0,annee:new Date().getFullYear(),type_conge:"mariage",etat:"en attente",valide_par:null,comment:"",user:{name:"",email:"",role:"user",remaining_days:18}}),[S,N]=l.useState(null),[k,F]=l.useState(!1),[r,h]=l.useState({});l.useEffect(()=>{m&&D(m)},[m]);const j=u=>{if(console.log("Changing type_conge to:",u),D(o=>{console.log("Previous form data:",o);const t={...o,type_conge:u};return console.log("New form data:",t),t}),s.date_debut){const o=new Date(s.date_debut),t=new Date(o);switch(u){case"mariage":t.setDate(t.getDate()+3);break;case"naissance":t.setDate(t.getDate()+2);break;case"deces":t.setDate(t.getDate()+2);break;default:return}D(c=>({...c,date_fin:t.toISOString().split("T")[0]}))}},f=u=>{const o=u.target.value;if(D(t=>({...t,date_debut:o})),o){const t=new Date(o),c=new Date(t);switch(s.type_conge){case"mariage":c.setDate(c.getDate()+3);break;case"naissance":c.setDate(c.getDate()+2);break;case"deces":c.setDate(c.getDate()+2);break;default:return}D(b=>({...b,date_fin:c.toISOString().split("T")[0]}))}},_=u=>{const{name:o,value:t}=u.target;D(c=>({...c,[o]:o==="nbr_jours"||o==="annee"||o==="user_id"?parseInt(t):t})),r[o]&&h(c=>{const b={...c};return delete b[o],b})},q=async u=>{var o,t,c,b;u.preventDefault(),F(!0),N(null),h({});try{const x={_method:"PUT",date_demande:s.date_demande,date_debut:s.date_debut,date_fin:s.date_fin,type_conge:s.type_conge,etat:s.etat,comment:s.comment},v=await M.post(`/demandes/${m==null?void 0:m.id}`,x,{headers:{"X-Requested-With":"XMLHttpRequest",Accept:"application/json"},withCredentials:!0});if(v.data){N({type:"success",text:"Demande mise à jour avec succès"});const E={...s,...v.data};V(E),setTimeout(()=>{y()},1500)}}catch(x){if(console.error("Error updating demande:",x),M.isAxiosError(x))if(((o=x.response)==null?void 0:o.status)===419)N({type:"error",text:"Session expirée. Veuillez rafraîchir la page et réessayer."});else if(((t=x.response)==null?void 0:t.status)===422&&x.response.data.errors){h(x.response.data.errors);const v=Object.values(x.response.data.errors).flat().join(", ");N({type:"error",text:v})}else N({type:"error",text:((b=(c=x.response)==null?void 0:c.data)==null?void 0:b.message)||"Une erreur s'est produite lors de la mise à jour de la demande"});else N({type:"error",text:"Une erreur s'est produite lors de la mise à jour de la demande"})}finally{F(!1)}};return e.jsx(K,{open:I,onOpenChange:y,children:e.jsxs(Q,{className:"max-h-[90vh] flex flex-col w-[95vw] sm:w-[85vw] md:w-[75vw] lg:w-[60vw] xl:w-[50vw]",children:[e.jsxs(Z,{children:[e.jsx(ee,{children:"Modifier la demande de congé"}),e.jsx(te,{children:"Modifiez les informations de la demande de congé ci-dessous."})]}),e.jsx("div",{className:"flex-1 overflow-y-auto pr-4 -mr-4",children:e.jsxs("form",{onSubmit:q,className:"space-y-4",children:[S&&e.jsx("div",{className:`p-2 rounded ${S.type==="success"?"bg-green-200 text-green-800":"bg-red-200 text-red-800"}`,children:S.text}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{htmlFor:"type_conge",className:"text-sm font-medium",children:"Type de congé"}),e.jsxs(R,{value:s.type_conge,onValueChange:u=>{j(u)},children:[e.jsx(U,{children:e.jsx($,{placeholder:"Sélectionner un type de congé"})}),e.jsxs(X,{children:[e.jsx(g,{value:"mariage",children:"Congé de Mariage (4 jours max)"}),e.jsx(g,{value:"naissance",children:"Congé de Naissance (3 jours)"}),e.jsx(g,{value:"deces",children:"Congé de Décès (3 jours max)"}),e.jsx(g,{value:"sans_solde",children:"Congé sans solde"}),e.jsx(g,{value:"recuperation",children:"Récupération"})]})]}),s.type_conge==="mariage"&&e.jsx("p",{className:"text-sm text-gray-500",children:"4 jours dont deux jours payés et deux jours déduits automatiquement du congé"}),s.type_conge==="naissance"&&e.jsx("p",{className:"text-sm text-gray-500",children:"3 jours - à prendre dans un délai de un mois à compter de la date de la naissance"}),s.type_conge==="deces"&&e.jsx("p",{className:"text-sm text-gray-500",children:"3 jours (décès conjoint, d'un enfant, d'un petit-enfant, d'un ascendant), dont un jour payé et deux jours déduits automatiquement du congé"}),s.type_conge==="sans_solde"&&e.jsx("p",{className:"text-sm text-gray-500",children:"Ce congé sera déduit automatiquement de votre salaire"}),s.type_conge==="recuperation"&&e.jsx("p",{className:"text-sm text-gray-500",children:"La journée à récupérer doit se faire dans un délai de 2 mois"})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{htmlFor:"nbr_jours",className:"text-sm font-medium",children:"Nombre de jours"}),e.jsx(T,{id:"nbr_jours",type:"number",name:"nbr_jours",value:s.nbr_jours,className:"w-full",readOnly:!0}),e.jsx("p",{className:"text-gray-500 text-xs",children:"Calculé automatiquement à partir des dates"})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{htmlFor:"date_debut",className:"text-sm font-medium",children:"Date de début"}),e.jsx(T,{id:"date_debut",type:"date",name:"date_debut",value:s.date_debut,onChange:f,className:r.date_debut?"border-red-500":"",required:!0}),r.date_debut&&e.jsx("p",{className:"text-red-500 text-xs",children:r.date_debut[0]})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{htmlFor:"date_fin",className:"text-sm font-medium",children:"Date de fin"}),e.jsx(T,{id:"date_fin",type:"date",name:"date_fin",value:s.date_fin,onChange:_,className:r.date_fin?"border-red-500":"",required:!0,readOnly:s.type_conge==="mariage"||s.type_conge==="naissance"||s.type_conge==="deces"}),r.date_fin&&e.jsx("p",{className:"text-red-500 text-xs",children:r.date_fin[0]}),(s.type_conge==="mariage"||s.type_conge==="naissance"||s.type_conge==="deces")&&e.jsx("p",{className:"text-sm text-gray-500",children:"La date de fin est automatiquement calculée en fonction de la date de début"})]})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{htmlFor:"comment",className:"text-sm font-medium",children:"Commentaire"}),e.jsx(H,{id:"comment",name:"comment",value:s.comment||"",onChange:_,placeholder:"Entrez la raison de votre demande...",className:`min-h-[100px] ${r.comment?"border-red-500":""}`}),r.comment&&e.jsx("p",{className:"text-red-500 text-xs",children:r.comment[0]})]}),P?e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{htmlFor:"etat",className:"text-sm font-medium",children:"État"}),e.jsxs("select",{id:"etat",name:"etat",value:s.etat,onChange:_,className:`w-full p-2 border rounded ${r.etat?"border-red-500":""}`,required:!0,children:[e.jsx("option",{value:"en attente",children:"En attente"}),e.jsx("option",{value:"acceptée",children:"Acceptée"}),e.jsx("option",{value:"refusée",children:"Refusée"})]}),r.etat&&e.jsx("p",{className:"text-red-500 text-xs",children:r.etat[0]})]}):e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{htmlFor:"etat",className:"text-sm font-medium",children:"État"}),e.jsx(T,{id:"etat",type:"text",value:s.etat,readOnly:!0,className:"bg-gray-100 cursor-not-allowed"})]})]})}),e.jsxs(ae,{className:"mt-4 flex-col sm:flex-row gap-2",children:[e.jsx(z,{variant:"outline",type:"button",onClick:y,disabled:k,className:"w-full sm:w-auto",children:"Annuler"}),e.jsx(z,{type:"submit",disabled:k,onClick:q,className:"w-full sm:w-auto",children:k?"Mise à jour...":"Modifier demande"})]})]})})};export{xe as A,pe as E};
